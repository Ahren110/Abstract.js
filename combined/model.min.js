/**
 * SodaRender
 * light Tml render engine
 * copyright @ Tencent AlloyTeam
 * License under MIT License
 * @author dorsywang
 * @email 314416946@qq.com
 * @blog http://www.dorsywang.com
 * @TeamBlog http://www.alloyteam.com
 */(function(){var e=/\{\{([^\}]*)\}\}/g,t=function(e){return new RegExp("(^|\\s+)"+e+"(\\s+|$)","g")},n=function(e,n){if(!e.className){e.className=n;return}e.className.match(t(n))||(e.className+=" "+n)},r=function(e,n){e.className=e.className.replace(t(n),"")},i=function(e,t){var n=t.indexOf(".");if(n>-1){var r=t.substr(0,n);return t=t.substr(n+1),e[r]?i(e[r],t):""}return e[t]||""},s=function(e){},o=/[a-zA-Z_\$]+[\w\$]*/g,u=/"([^"]*)"|'([^']*)'/g,a=/\d+|\d*\.\d+/g,f=/[a-zA-Z_\$]+[\w\$]*(?:\s*\.\s*(?:[a-zA-Z_\$]+[\w\$]*|\d+))*/g,l=/\[([^\[\]]*)\]/g,c=/\.([a-zA-Z_\$]+[\w\$]*)/g,h=/[^\.|]([a-zA-Z_\$]+[\w\$]*)/g,p=function(){return"$$"+~~(Math.random()*1e6)},d=function(e,t){var e=e.split("|"),n=e[0]||"",r=e.slice(1);n=n.replace(u,function(e,n,r){var i=p();return t[i]=n||r,i});while(l.test(n))l.lastIndex=0,n=n.replace(l,function(e,n){return"."+d(n,t)});n=n.replace(f,function(e){return"getValue(scope,'"+e.trim()+"')"});var s=function(){var e=r.shift();if(!e)return;var e=e.split(":"),t=e.slice(1)||[],i=e[0]||"";g[i]&&(t.unshift(n),t=t.join(","),n="sodaFilterMap['"+i+"']("+t+")"),s()};s();var o=(new Function("getValue","sodaFilterMap","return function sodaExp(scope){ return "+n+"}"))(i,g);return o(t)},v=function(t,n){[].map.call([].slice.call(t.childNodes,[]),function(t){t.nodeType===3&&(t.nodeValue=t.nodeValue.replace(e,function(e,t){return d(t,n)})),t.attributes&&(/in/.test(t.getAttribute("soda-repeat")||"")?m["soda-repeat"].link(n,t,t.attributes):([].map.call(t.attributes,function(r){if(/^soda-/.test(r.name)){if(m[r.name]){var i=m[r.name];i.link(n,t,t.attributes)}}else r.value=r.value.replace(e,function(e,t){return d(t,n)})}),v(t,n)))})},m={},g={},y=function(e,t){m["soda-"+e]=t()},b=function(e,t){g[e]=t};b("date",function(e,t){return t}),y("repeat",function(){return{compile:function(e,t,n){},link:function(t,n,r){var s=n.getAttribute("soda-repeat"),o,u;if(!/in/.test(s))return;s=s.split("in"),o=s[0].trim(),u=s[1].trim();var a=i(t,u),f=n;for(var l=0;l<a.length;l++){var c=n.cloneNode(),h={$index:l};h[o]=a[l],h.__proto__=t,c.innerHTML=n.innerHTML,[].map.call(c.attributes,function(t){if(c.getAttribute("removed")==="removed")return;if(t.name.trim()!=="soda-repeat")if(/^soda-/.test(t.name)){if(m[t.name]){var n=m[t.name];n.link(h,c,c.attributes)}}else t.value=t.value.replace(e,function(e,t){return d(t,h)})}),c.getAttribute("removed")!=="removed"&&(v(c,h),n.parentNode.insertBefore(c,f.nextSibling),f=c)}n.parentNode.removeChild(n)}}}),y("if",function(){return{link:function(e,t,n){var r=t.getAttribute("soda-if"),i=d(r,e);i||(t.setAttribute("removed","removed"),t.parentNode&&t.parentNode.removeChild(t))}}}),y("class",function(){return{link:function(e,t,r){var i=t.getAttribute("soda-class"),s=d(i,e);s&&n(t,s)}}});var w=function(e,t){var n=document.createElement("div");n.innerHTML=e,v(n,t);var r=document.createDocumentFragment();r.innerHTML=n.innerHTML;var i;while(i=n.childNodes[0])r.appendChild(i);return r},E=function(e,t){};window.sodaRender=w,window.sodaFilter=b})(),function(){var e=console.info,t=console.log,n=[];console.log=function(){n=arguments,t.apply(console,arguments)},console.info=function(){var t=arguments[1],r,i=Array.prototype.slice.call(arguments,0),s=arguments;n[0]&&n[0]==="Model:"&&(s[0]="\u266b",n[1]&&n[1]===t&&(s[1]=" \u2197")),e.apply(console,s),n=i};var r=function(e){this.bubble=!0,this.type=e.type||"",this.name=e.name,this.target=e.target};r.prototype={constructor:r,stopPropagation:function(){this.bubble=!1}};var i={_config:{ajax:function(e){if(window.$&&$.ajax)$.ajax(e);else{var t=new XMLHttpRequest,n=[];if(e.data)for(var r in e.data)n.push(r+"="+e.data[r]);n=n.join("&"),t.onload=function(){var t=this.response,n=(this.getResponseHeader("Content-type")||"").toLowerCase(),r=this.status;r===200||r===304?(/json/.test(n)&&(t=JSON.parse(t)),e.success(t)):e.error(t)},t.open(e.method,e.url,!0),t.send(n)}},tmpl:function(e,t,n){var r=sodaRender(e.tmpl||"",t),i=e.el;window.$?i=$(i):typeof i=="string"&&(i=document.querySelector(i)),i[0]&&(i=i[0]),i instanceof HTMLElement?(n&&(i.innerHTML=""),i&&i.appendChild(r)):console.info("Model: option el is not an HTMLElement")},localKeyExclude:[]},config:function(e){e.ajax&&(this._config.ajax=e.ajax),this._config.tmpl=e.tmpl},fuseMap:{},Class:function(e,t){var n=e,r=t;if(typeof e=="string"){n=window[e];if(!n)return console.warn("Model:",e,"not included, Please check your Model files!"),{}}r&&typeof n!="function"&&console.warn("Model:",e,"is not illegal"),t||(r=n,n=null),n&&(n=new n,r.__proto__=n,r.super=n,r.callSuper=function(){var e=["constructor"].concat([].slice.call(arguments,0));this.callSuperMethod.apply(this,e)},r.callSuperMethod=function(){var e=[].slice.call(arguments,0,1),t=[].slice.call(arguments,1)||[],n=this.super;n&&(this.super=n.super,(n[e]||function(){}).apply(this,t),this.super=n)});var i=function(){};return r.hasOwnProperty("constructor")?i=r.constructor:i=function(){r.constructor.apply(this,arguments)},i.prototype=r,i},trigger:function(e){if(this.fuseMap[e]){var t=this.createEvent({target:this.fuseMap[e],name:e,type:"actived"});this.fuseMap[e].rock(t)}},external:function(e,t){window[e]=t},createEvent:function(e){return new r(e)},addFuse:function(e,t){this.fuseMap[e]=t}};i.external("Model",i)}(),function(){var e=["tmpl","el","data","fuse","myData","onreset"],t=Model.Class({type:"BaseModel",get acceptOpt(){return e},addAcceptOpt:function(t){e=e.concat(t)},set fuse(e){Model.addFuse(e,this),this._fuse=e},get fuse(){return this._fuse},constructor:function(e){this._fuse="";if(e)for(var t=0;t<this.acceptOpt.length;t++){var n=this.acceptOpt[t];e[n]&&(this[n]=e[n])}this.eventHandler={},this.children=[],this.parent=null;var r=this;this.addEventListener("reset",function(e){r.onreset&&r.onreset()})},add:function(e){e.parent=this,this.children.push(e)},del:function(e){for(var t=0;t<this.children.length;t++)if(this.children[t]===e)break;this.children.splice(t,1)},remove:function(){this.parent&&this.parent.del(this)},active:function(e){},unactive:function(e){},rock:function(e){console.log(this.el,"rocked"),this.status="active";var t=Model.createEvent({type:"actived",target:this,name:e||"anonymouse"});this.active(t),this.dispatchEvent(t)},stop:function(e){console.log(this.el,"unrocked"),this.status="unactive";var t=Model.createEvent({type:"unactived",target:this,name:e||"anonymouse"});this.unactive(t),this.dispatchEvent(t)},dispatchEvent:function(e){var t=e.type,n=this;this.eventHandler[t]&&this.eventHandler[t].map(function(t){t.call(n,e)}),e.bubble&&this.parent&&this.parent.dispatchEvent(e)},addEventListener:function(e,t,n){this.eventHandler[e]||(this.eventHandler[e]=[]),this.eventHandler[e].push(t)},info:function(e){var t=[],t=["Model:",(this.comment||(typeof this.el=="string"?this.el:this.el&&this.el.selector))+":"];for(var n=0;n<arguments.length;n++)t.push(arguments[n]);console.info.apply(console,t)},reset:function(){var e=Model.createEvent({type:"reset",target:this,name:"anonymouse"});this.dispatchEvent(e)},freeze:function(){this.freezed=1},melt:function(){this.freezed=0}});Model.external("BaseModel",t)}(),function(){var e=Model.Class("BaseModel",{type:"RelationModel",constructor:function(e){this.callSuper(e)},setActive:function(e){this.onactive=e},setUnactive:function(e){this.onactive=e}});Model.external("RelationModel",e)}(),function(){var e=Model.Class("RelationModel",{type:"PageModel",constructor:function(e){this.callSuper(e)},active:function(e){this.children.map(function(t){t.status!=="active"&&t.rock(e)})},unactive:function(e){this.children.map(function(t){(t.status==="active"||!t.status)&&t.stop(e)})}});Model.external("PageModel",e)}(),function(){var e=Model.Class("RelationModel",{type:"MutexModel",constructor:function(e){this.callSuper(e),this.addEventListener("actived",function(e){var t=e.target;if(!t)return;if(t.parent===this&&this.currChild!==this){for(var n=0;n<this.children.length;n++){var r=this.children[n];r!==t&&r.stop()}this.currChild=t}})},active:function(e){this.currChild?this.currChild.rock(e):(this.currChild=this.children[0],this.currChild&&this.currChild.rock(e))},unactive:function(e){this.children.map(function(t){(t.status==="active"||!t.status)&&t.stop(e)})}});Model.external("MutexModel",e)}(),function(){var e=function(e,t){var n={};for(var r in t){var i=Model._config.localKeyExclude||[];if(i.length){if(i.indexOf&&i.indexOf(r))continue}else{var s=0;for(var o=0;o<i.length;o++)r==i[o]&&(s=1);if(s)continue}n[r]=t[r]}var u=e+"_"+JSON.stringify(n);return u},t=Model.Class("BaseModel",{type:"RenderModel",getData:function(t){var n=this,r,i=n.paramCache[n.cgiCount]||typeof this.param=="object"&&this.param||typeof this.param=="function"&&this.param.call(this)||{},s=i;if(this._args){var o=JSON.stringify(i);for(var u=0;u<this._args.length;u++){var a=u+1;o=o.replace(new RegExp("@param"+a,"g"),this._args[u]||"")}o=o.replace(/@param\d+/g,""),s=JSON.parse(o)}var f={method:"POST",url:this.url,data:s,success:function(o,u){if(u){t(o);return}n.dataCache[n.cgiCount]=o,n.paramCache[n.cgiCount]=i,n.cgiCount++;if(n.cgiCount==1){var a=(n.cacheKey||e)(n.url,s);if(a)try{window.localStorage.setItem(a,JSON.stringify(o))}catch(f){window.localStorage.clear(),window.localStorage.setItem(a,JSON.stringify(o))}}r,n.info("complete request, with res\u2199"),n.info("   ",o),t(o)},error:function(e){n.info("\u3128error request, with res\u2199"),n.info("   ",e),n.paramCache[n.cgiCount]=i,n.cgiCount++,n.error&&n.error.call(n,e,n.cgiCount)}};if(this.usePreLoad&&this.preLoadData){this.info("with preload Data"),this.usePreLoad=!1;if(this.preLoadData.type!="error"&&this.preLoadData.retcode==0){f.succ(this.preLoadData);return}}if(this.dead)return;if(!n.noCache&&n.cgiCount==0){var l=(n.cacheKey||e)(this.url,s);r=null;try{r=JSON.parse(window.localStorage.getItem(l)||"{}")}catch(c){}if(r)try{this.info("has localData"),this.info("    start localData rendering"),f.success(r,1)}catch(c){}n.isFirstRender=0,this.localData=r}if(this.dataCache[n.cgiCount])this.dataCache[n.cgiCount]==="@prefeching"?this.dataCache[n.cgiCount]=function(e){e?f.err(n.dataCache[n.cgiCount]):f.succ(n.dataCache[n.cgiCount])}:f.succ(this.dataCache[n.cgiCount]);else{var h=this.beforeRequest&&this.beforeRequest();if(typeof h=="boolean"&&!h)return;this.info("start to request cgi, with request params\u2199"),this.info("    cgi: "+f.url),this.info("   ",s),Model._config.ajax(f)}},render:function(e,t){var n=this,r=Model._config.tmpl,i=function(i){if(n.dead)return;n.cgiCount===1&&(n.onreset&&n.onreset(),e.innerHTML=""),n.info("start to process data"),n.processData&&n.processData.call(n,i,n.cgiCount);var s={tmpl:n.tmpl,helper:n.helper,el:n.el};r(s,i,t),n.cgiCount>0&&(n.scrollEnable=1),n.eventsBinded||(n.events&&typeof n.events=="function"&&n.events(),n.hasOwnProperty("eventsBinded")?n.eventsBinded=1:n.__proto__.eventsBinded=1),n.feedPool.map(function(e){e.noFeed||(e.setFeedData(i,n.cgiCount),e.rock())}),n.info("start to complete data"),n.complete&&n.complete(i,n.cgiCount),n.isFirstDataRequestRender++,n.info("complete render")};this.url?this.getData(i):(this.data||(this.data={}),this.info("   data given\u2199"),this.info("   ",this.data),i(this.data))},active:function(){if(!this.rendered){this.rendered=1;var e=this.el;typeof e=="string"&&(e=window.$?$(e):document.querySelector(e)),this.render(e,1)}},_resetPrivateFlag:function(){this.rendered=0,this.feedPool=[],this.cgiCount=0},constructor:function(e){this.addAcceptOpt(["complete","processData","error","url","param","noCache","events"]),this.callSuper(e),this._resetPrivateFlag(),this.eventsBinded=0,this.paramCache=[],this.dataCache=[];var t=this;this.addEventListener("reset",function(e){e.target===this&&(this.cgiCount=0,this.melt())})},extend:function(e){e||(e={});var t=function(){},n=e.events;t.prototype=this;var r=new t;this._resetPrivateFlag.call(r),e.param&&(r.paramCache=[]);for(var i in e)r[i]=e[i];return n&&(r.events=function(){n&&n.call(this)},r.eventsBinded=0),r}});Model.external("RenderModel",t)}();var ScrollModel=Model.Class("RenderModel",{})